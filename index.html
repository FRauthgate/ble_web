<html>
<head>
<title>Coke vending machine nearby!</title>

<link rel="icon" type="image/png" href="coke.png"/>

<script>

async function onButtonClick1() 
{
  let filters = [];

  filters.push({services: ['b56a46b1-2b62-87aa-a241-3abdaa426dfb']});

  try {
//alert('Requesting Bluetooth Device...');
    const device = await navigator.bluetooth.requestDevice({filters: filters});

	let server = await device.gatt.connect();
	if (server === null) alert("Failed to connect");
//alert(server);

	let service = await server.getPrimaryService('b56a46b1-2b62-87aa-a241-3abdaa426dfb');
	if (service === null) alert("Failed to find service");

//alert(service);

	let characteristic = await service.getCharacteristic('ae955bc6-3fa0-4b88-a7d7-74a7706a0d58');
	let value = await characteristic.readValue();
	document.querySelector('#Amount').textContent = new TextDecoder('utf-8').decode(value);


	characteristic = await service.getCharacteristic('f630dca5-5f98-49b6-8691-9727242dfecb');
	value = await characteristic.readValue();
	document.querySelector('#Currency').textContent = new TextDecoder('utf-8').decode(value);

	characteristic = await service.getCharacteristic('c7cb692f-c26f-438d-8092-bb4aa13e1a90');
	value = await characteristic.readValue();
	document.querySelector('#Merchant').textContent = new TextDecoder('utf-8').decode(value);

	} catch(exception) {
		alert(exception);
		if (device.gatt.connected) {
			device.gatt.disconnect();
		}
	}
}


async function onButtonClick2() 
{
	navigator.bluetooth.requestDevice(
	{
		filters: [{
			services: ['b56a46b1-2b62-87aa-a241-3abdaa426dfb'],
		}]
	})
	.then(device => device.gatt.connect())
	.then(server => { server.getPrimaryService('b56a46b1-2b62-87aa-a241-3abdaa426dfb'); })
	.then(service => { alert("OK"); service.getCharacteristic('ae955bc6-3fa0-4b88-a7d7-74a7706a0d58'); })
	.then(characteristic => { alert(characteristic.readValue()); });
}


async function onButtonClick3() 
{
	navigator.bluetooth.requestDevice({
		filters: [{
			services: ['b56a46b1-2b62-87aa-a241-3abdaa426dfb']
		}]
	})
	.then(device => {
//		alert('Got device:' + device.name);
//		alert('id:' + device.id);
		return device.gatt.connect(); 
	})
	.then(server => {
//		alert('Getting Service');
		return server.getPrimaryService('b56a46b1-2b62-87aa-a241-3abdaa426dfb');
	})
	.then(service => {
//		alert('Getting Characteristic');
		return service.getCharacteristic('ae955bc6-3fa0-4b88-a7d7-74a7706a0d58');
	})
	.then(characteristic => {
//		alert('Reading amount');
		return characteristic.readValue();
	})
	.then(value => {
		var decoder = new TextDecoder('utf-8');
        var decodedString = decoder.decode(value);
//		alert('Amount:' + decodedString);
		document.querySelector('#Amount').textContent = decodedString;
	})
	.then(service => {
//		alert('Getting Characteristic');
		return service.getCharacteristic('f630dca5-5f98-49b6-8691-9727242dfecb');
	})
	.then(characteristic => {
		characteristic.addEventListener('characteristicvaluechanged', alert('Charx changed'));
		characteristic.startNotifications();
//		alert('Reading amount');
		return characteristic.readValue();
	})
	.then(value => {
		var decoder = new TextDecoder('utf-8');
		document.querySelector('#Currency').textContent = decoder.decode(value);
	})
	.catch(exception => {
		alert(exception);
	});
}

async function onButtonClick4() 
{
	alert(await navigator.bluetooth.referringDevice);
	alert(await navigator.bluetooth.referringDevice.name);
}

</script>

</head>

<body>

Hello 37:</br> 
<button onClick="onButtonClick1();">Test 1</button></br>
<button onClick="onButtonClick2();">Test 2</button></br>
<button onClick="onButtonClick3();">Test 3</button></br>
<button onClick="onButtonClick4();">Test 4</button></br>

<h3>Live Output</h3>
<div id="output" class="output">
  <div>Amount: <span id="Amount"></span></div>
  <div>Currency: <span id="Currency"></span></div>
  <div>Merchant: <span id="Merchant"></span></div>
</div>

</body>
</html>